<?php
/**
 * 主贴管理
 */
namespace Admin\Controller;

class ZhutieController extends BaseController {
    
    protected  $discussZhutieModel;

    public function  __construct()
    {
        parent::__construct();
        $this->discussZhutieModel = M('discuss_zhutie');
    }

    public function index()
    {

        //获取查询条件
        $map =array_filter(I());
        // 分页
        $count  = D('discuss_zhutie')->where($this->serach($map))->count();
        $Page = new  \Think\Page($count, 2);

        if($this->serach($map)){

            foreach($this->serach($map) as $key=>$val) {
                $Page->parameter[$key]   =   urlencode($val);
            }
        }

        //查询记录
        $discussZhuties = D('discuss_zhutie')
                                ->where($this->serach($map))
                                ->join('__USERS__ ON __DISCUSS_ZHUTIE__.admin_id = __ADMIN__.id')
                                ->field('users.username,discss_zhutie.*')
                                ->limit($Page->firstRow.','.$Page->listRows);
        $show = $Page->show();
        $a = D('discuss_zhutie')->_sql();
        echo $a;die;
        // var_dump($count);die;
        //分配
        $this->assign('page',$show);
        $this->assign('discussZhuties',$discussZhuties);
        $this->assign('count',$count);

        // 视图
        $this->display();
    }


    //后台用户不添加帖子
    // public function  add()
    // {
    //     $this->display();
    // }

    // public function  doadd()
    // {

    // }

    public function  disabled()
    {

    }

    public function edit()
    {
        $obj =    $this->discussZhutieModel->find(I('get.id'));

          if($obj) {
              $this->assign('obj',$obj);
              $this->display();
          }else{
              $this->error('该帖子不存在','/Admin/Zhutie',3);
          }
    }

    public function doEdit()
    {
        if(IS_POST) {
            $data = I();

            $res = $this->discussZhutieModel->save($data);

            if($res){
                $this->ajaxReturn(array('status'=>'ok'));
            }else{
                $this->ajaxReturn(array('status'=>'error'));
            }
        }
    }

    public function  delete()
    {
        $data = I();
        $res = $this->discussZhutieModel->where('id='.$data['id'])->delete();

        if($res) {
            $this->ajaxReturn(array('status'=>'ok'));
        }else{
            $this->ajaxReturn(array('status'=>'error'));
        }
    }
}